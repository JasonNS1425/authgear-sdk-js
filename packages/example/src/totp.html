<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="/skygear-web.iife.js"></script>
  <script src="/helper.js"></script>
  <title>Time-based One-time Password (TOTP)</title>
</head>
<body>
  <div class="container">
    <a href="/">
      <h2>Back to Index</h2>
    </a>
  </div>

  <form class="container" onsubmit="onSubmitCreate(event)">
    <div class="form-group">
      <h1>Create TOTP Authenticator</h1>
    </div>
    <div class="form-group">
      <label>Display Name</label>
      <input id="displayName" type="text" class="form-control" placeholder="Display Name" oninput="onInputCreate()">
    </div>
    <div class="form-group">
      <label>Issuer</label>
      <input id="issuer" type="text" class="form-control" placeholder="Issuer" oninput="onInputCreate()">
    </div>
    <div class="form-group">
      <label>Account Name</label>
      <input id="accountName" type="text" class="form-control" placeholder="Account Name" oninput="onInputCreate()">
    </div>
    <div class="form-group">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <div class="form-group">
      <label>Synopsis</label>
      <textarea id="createSynopsis" class="form-control" readonly=""></textarea>
    </div>
    <div class="form-group">
      <label>Result</label>
      <textarea id="createResult" class="form-control" readonly=""></textarea>
    </div>
    <div class="form-group">
      <img id="qrCode">
    </div>
  </form>

  <form class="container" onsubmit="onSubmitActivate(event)">
    <div class="form-group">
      <h1>Activate TOTP Authenticator</h1>
    </div>
    <div class="form-group">
      <label>OTP</label>
      <input id="activateOTP" type="text" class="form-control" placeholder="OTP" oninput="onInputActivate()">
    </div>
    <div class="form-group">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <div class="form-group">
      <label>Synopsis</label>
      <textarea id="activateSynopsis" class="form-control" readonly=""></textarea>
    </div>
    <div class="form-group">
      <label>Result</label>
      <textarea id="activateResult" class="form-control" readonly=""></textarea>
    </div>
  </form>

  <form class="container" onsubmit="onSubmitAuthenticate(event)">
    <div class="form-group">
      <h1>Authenticate with TOTP Authenticator</h1>
    </div>
    <div class="form-group">
      <label>OTP</label>
      <input id="authenticateOTP" type="text" class="form-control" placeholder="OTP" oninput="onInputAuthenticate()">
    </div>
    <div class="form-group">
      <label>Skip MFA for Current Device</label>
      <input id="skipMFAForCurrentDevice" type="checkbox" class="form-control"  oninput="onInputAuthenticate()">
    </div>
    <div class="form-group">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <div class="form-group">
      <label>Synopsis</label>
      <textarea id="authenticateSynopsis" class="form-control" readonly=""></textarea>
    </div>
    <div class="form-group">
      <label>Result</label>
      <textarea id="authenticateResult" class="form-control" readonly=""></textarea>
    </div>
  </form>

  <script>

function onInputCreate() {
  var displayName = document.getElementById("displayName").value;
  var issuer = document.getElementById("issuer").value;
  var accountName = document.getElementById("accountName").value;

  var synopsisTextArea = document.getElementById("createSynopsis");

  var funcExpr = "skygear.auth.mfa.createNewTOTP";
  var s = stringifyFunctionCall(funcExpr, {
    displayName,
    issuer,
    accountName,
  });

  synopsisTextArea.value = s;
}

function onSubmitCreate(e) {
  e.preventDefault();
  e.stopPropagation();

  var displayName = document.getElementById("displayName").value;
  var issuer = document.getElementById("issuer").value;
  var accountName = document.getElementById("accountName").value;
  var resultTextArea = document.getElementById("createResult");
  var qrCode = document.getElementById("qrCode");

  skygear.auth.mfa.createNewTOTP({
    displayName,
    issuer,
    accountName,
  }).then(function(result) {
    resultTextArea.value = JSON.stringify(result);
    qrCode.src = result.qrCodeImageURI;
  }, function(error) {
    resultTextArea.value = JSON.stringify(error);
  });
}

function onInputActivate() {
  var otp = document.getElementById("activateOTP").value;

  var synopsisTextArea = document.getElementById("activateSynopsis");

  var funcExpr = "skygear.auth.mfa.activateTOTP";
  var s = stringifyFunctionCall(funcExpr, otp);

  synopsisTextArea.value = s;
}

function onSubmitActivate(e) {
  e.preventDefault();
  e.stopPropagation();

  var otp = document.getElementById("activateOTP").value;
  var resultTextArea = document.getElementById("activateResult");

  skygear.auth.mfa.activateTOTP(otp).then(function(result) {
    resultTextArea.value = JSON.stringify(result);
  }, function(error) {
    resultTextArea.value = JSON.stringify(error);
  });
}

function onInputAuthenticate() {
  var otp = document.getElementById("authenticateOTP").value;
  var skipMFAForCurrentDevice = document.getElementById("skipMFAForCurrentDevice").checked;

  var synopsisTextArea = document.getElementById("authenticateSynopsis");

  var funcExpr = "skygear.auth.mfa.authenticateWithTOTP";
  var s = stringifyFunctionCall(funcExpr, {
    otp,
    skipMFAForCurrentDevice,
  });

  synopsisTextArea.value = s;
}

function onSubmitAuthenticate(e) {
  e.preventDefault();
  e.stopPropagation();

  var otp = document.getElementById("authenticateOTP").value;
  var skipMFAForCurrentDevice = document.getElementById("skipMFAForCurrentDevice").checked;
  var resultTextArea = document.getElementById("authenticateResult");

  skygear.auth.mfa.authenticateWithTOTP({
    otp,
    skipMFAForCurrentDevice,
  }).then(function(user) {
    resultTextArea.value = JSON.stringify(user);
  }, function(error) {
    resultTextArea.value = JSON.stringify(error);
  });
}

skygear.configure({
  appEndpoint: "__SKYGEAR_APP_ENDPOINT__",
  authEndpoint: "__SKYGEAR_AUTH_ENDPOINT__",
  assetEndpoint: "__SKYGEAR_ASSET_ENDPOINT__",
  clientID: "__SKYGEAR_CLIENT_ID__"
}).then(function() {
  onInputCreate();
  onInputActivate();
  onInputAuthenticate();
}, function(e) {
  console.error(e);
});
  </script>
</body>
</html>
